#!/bin/rc

if(! test -e /tmp/stononce)
	echo 1009 >tmp/stononce
nonce = `{cat /tmp/stononce}
if(! test -e /tmp/nextport)
	echo 20000 >/tmp/nextport
ndb/ipquery sys $sysname ip |sed 's/ip=127.0.0.1//' >/tmp/myip
. /tmp/myip

rfork
while(usercmd=`{read}){
	switch($usercmd){
	case spawn*
		stoport=`{cat /tmp/nextport}
		echo spawnroot -l $stoport $usercmd(2) >>/tmp/stolog.$pid
		spawnroot -l $stoport $usercmd(2) &
		echo 'echo fetch tcp!'^$ip^'!'^$stoport^' >>/n/g/cpu.in'
		stoport=`{echo $stoport '+ 2' |hoc}
		echo $stoport >/tmp/nextport
	case fetch*
		echo fetch not supported on storage node >[2=1]
	case save*
		echo savesnap $usercmd(2) $usercmd(3) $nonce >>/tmp/stolog.$pid
		savesnap -r /srv/^$usercmd(2) -s /srv/^$usercmd(2)^fscons $usercmd(3)^.^$nonce &
		nonce=`{echo $nonce ' + 100 ' |hoc}
		echo $nonce >/tmp/stononce
	case scores
		if(! test -e /n/9fat/scorenames)
			mount /srv/fatsrv /n/9fat
		cat /n/9fat/scorenames |uniq
	case log
		cat /tmp/scolog.$pid
	case clean*
		echo clean
	case exit
		exit
	case *
		echo unknown
	}
}

